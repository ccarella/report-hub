<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Updates from Tex</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <main>
    <header class="site-header">
      <h1 id="site-title">Updates from Tex</h1>
      <input type="search" id="search" class="search-input" placeholder="Search reportsâ€¦" autocomplete="off">
    </header>
    <div class="report-cards" id="cards"></div>
  </main>
  <script>
    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    fetch('/manifest.json').then(r => r.json()).then(m => {
      document.getElementById('site-title').textContent = m.site.title;

      const cards = document.getElementById('cards');
      const searchInput = document.getElementById('search');

      function formatDate(iso) {
        const d = new Date(iso + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      }

      function fuzzyMatch(report, query) {
        if (!query) return true;
        const topic = m.topics[report.topic] || {};
        const type = m.reportTypes[report.type] || {};
        const haystack = [
          report.title,
          report.excerpt,
          topic.name || '',
          type.label || ''
        ].join(' ').toLowerCase();
        const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
        return terms.every(term => haystack.includes(term));
      }

      function render() {
        const query = searchInput.value.trim();
        const sorted = [...m.reports]
          .filter(r => fuzzyMatch(r, query))
          .sort((a, b) => b.date.localeCompare(a.date));

        if (!sorted.length) {
          cards.innerHTML = query
            ? '<div class="empty-state">No reports match your search.</div>'
            : '<div class="empty-state">No reports yet.</div>';
          return;
        }

        cards.innerHTML = sorted.map(r => {
          const topic = m.topics[r.topic] || {};
          const type = m.reportTypes[r.type] || {};
          return `<a class="card" href="/${esc(r.file)}">
            <div class="card-meta">
              <span class="badge">${esc(type.label || r.type)}</span>
              <span class="card-date">${formatDate(r.date)}</span>
            </div>
            <div class="card-title">${esc(r.title)}</div>
            <div class="card-excerpt">${esc(r.excerpt)}</div>
          </a>`;
        }).join('');
      }

      searchInput.addEventListener('input', render);
      render();
    }).catch(() => {
      document.getElementById('cards').innerHTML =
        '<div class="empty-state">Failed to load reports. Try refreshing.</div>';
    });
  </script>
</body>
</html>
